<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>公开留言区 - 昆承中学官网</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        github: '#24292e',
                        primary: '#2ea44f',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .message-appear {
                animation: fadeIn 0.5s ease-out;
            }
            /* 图片预览样式 */
            .image-preview {
                max-width: 100%;
                max-height: 300px;
                object-fit: contain;
                cursor: zoom-in;
                transition: opacity 0.3s ease;
            }
            .image-preview:hover {
                opacity: 0.9;
            }
            /* 图片加载中骨架屏 */
            .image-skeleton {
                width: 100%;
                max-height: 300px;
                background: #f0f0f0;
                border-radius: 4px;
                position: relative;
                overflow: hidden;
            }
            .image-skeleton::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 50%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                animation: skeleton-loading 1.5s infinite;
            }
            @keyframes skeleton-loading {
                100% { left: 100%; }
            }
            /* 图片放大模态框 */
            .modal-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }
            .modal-backdrop.active {
                opacity: 1;
                visibility: visible;
            }
            .modal-content {
                max-width: 95%;
                max-height: 90vh;
                position: relative;
            }
            .modal-image {
                max-width: 100%;
                max-height: 85vh;
                object-fit: contain;
            }
            .modal-close {
                position: absolute;
                top: -40px;
                right: 0;
                color: white;
                font-size: 28px;
                cursor: pointer;
                transition: transform 0.2s ease;
            }
            .modal-close:hover {
                transform: scale(1.1);
            }
            .modal-loading {
                color: white;
                font-size: 20px;
                display: flex;
                align-items: center;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            /* 优化版骨架屏 */
            .message-skeleton {
                @apply bg-white rounded-xl shadow-md p-4 animate-pulse;
            }
            .lazy-load {
                @apply opacity-0 transition-opacity 0.3s;
            }
            .lazy-load.loaded {
                @apply opacity-1;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">
    <!-- 导航栏 -->
    <header class="bg-gradient-to-r from-fbc2eb to-3b75da text-white py-4">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="text-2xl font-bold mb-4 md:mb-0">
                    <span class="highlight">昆承中学</span> 官网
                </div>
                <nav>
                    <ul class="flex flex-wrap justify-center gap-x-6 gap-y-2">
                        <li><a href="home.html" class="hover:underline">首页</a></li>
                        <li><a href="homestu.html" class="hover:underline">关于我们</a></li>
                        <li><a href="guestbook.html" class="font-bold underline">资源分享</a></li>
                        <li><a href="#" class="hover:underline">学生目录</a></li>
                        <li><a href="javascript:logout()" class="touch-friendly hover:underline">退出登录</a></li>
                        <li><span id="current-user" class="ml-2 text-sm opacity-90"></span></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-6 sm:py-8 max-w-4xl">
        <header class="text-center mb-6 sm:mb-12">
            <h1 class="text-[clamp(1.5rem,5vw,3rem)] font-bold text-github mb-2 flex items-center justify-center">
                <i class="fa fa-comments mr-3"></i>公开留言区
            </h1>
            <p class="text-gray-600 text-base sm:text-lg px-2">支持文字和图片留言，所有内容均公开存储</p>
        </header>
        
        <!-- 留言表单 -->
        <section id="guestbook-form-container" class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6 sm:mb-10">
            <h2 class="text-lg sm:text-xl font-semibold mb-4 text-github flex items-center">
                <i class="fa fa-pencil-square-o text-primary mr-2"></i>写下你的留言
            </h2>
            
            <form id="guestbook-form" class="space-y-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">昵称（≤50字符）</label>
                    <input 
                        type="text" 
                        id="name" 
                        required
                        maxlength="50"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none text-base"
                        placeholder="请输入你的昵称"
                    >
                </div>
                
                <div>
                    <label for="message" class="block text-sm font-medium text-gray-700 mb-1">留言内容（≤2000字符）</label>
                    <textarea 
                        id="message" 
                        rows="4" 
                        required
                        maxlength="2000"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none resize-none text-base"
                        placeholder="请输入你的留言..."
                    ></textarea>
                    <p class="mt-1 text-xs text-gray-500" id="char-count">0/2000 字符</p>
                </div>
                
                <!-- 图片上传区域（带压缩提示） -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">上传图片（可选，自动压缩至≤2MB，支持jpg/png/gif）</label>
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <label class="flex-1 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-primary transition-colors cursor-pointer touch-friendly" id="image-drop-area">
                            <input 
                                type="file" 
                                id="image-upload" 
                                accept="image/jpeg, image/png, image/gif" 
                                class="hidden"
                            >
                            <i class="fa fa-upload text-gray-400 text-xl mb-2"></i>
                            <p class="text-sm text-gray-500">点击或拖拽图片到此处</p>
                        </label>
                        
                        <div id="image-preview-container" class="hidden w-24 h-24 sm:w-32 sm:h-32 rounded-lg overflow-hidden border border-gray-200">
                            <img id="image-preview" class="image-preview" src="" alt="预览图">
                        </div>
                    </div>
                    <p id="image-size-error" class="mt-1 text-xs text-red-500 hidden">图片过大，已自动压缩至2MB以内</p>
                    <p id="image-compress-info" class="mt-1 text-xs text-green-500 hidden">图片已压缩（原始大小: <span id="original-size"></span> → 压缩后: <span id="compressed-size"></span>）</p>
                </div>
                
                <button 
                    type="submit" 
                    class="w-full sm:w-auto bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 flex items-center justify-center touch-friendly"
                    id="submit-btn"
                >
                    <i class="fa fa-paper-plane mr-2"></i>发送留言
                </button>
            </form>
        </section>
        
        <!-- 留言控制区 -->
        <section id="messages-control" class="mb-4 sm:mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
            <h2 class="text-lg sm:text-xl font-semibold text-github flex items-center">
                <i class="fa fa-list-alt text-primary mr-2"></i>所有留言
            </h2>
            
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full sm:w-auto">
                <span id="message-count" class="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full text-sm w-full sm:w-auto text-center">
                    加载中...
                </span>
                
                <div class="flex items-center border rounded-md overflow-hidden w-full sm:w-auto">
                    <button id="sort-newest" class="flex-1 sm:flex-none px-4 py-2 bg-primary text-white text-sm touch-friendly">最新在前</button>
                    <button id="sort-oldest" class="flex-1 sm:flex-none px-4 py-2 bg-gray-100 text-gray-700 text-sm hover:bg-gray-200 touch-friendly">最早在前</button>
                </div>
            </div>
        </section>
        
        <!-- 留言列表 -->
        <section id="messages-container">
            <div id="messages-list" class="space-y-4 sm:space-y-6">
                <div class="flex justify-center py-10">
                    <i class="fa fa-circle-o-notch fa-spin text-2xl text-gray-400"></i>
                </div>
            </div>
            
            <div class="mt-6 sm:mt-8 text-center">
                <button id="load-more" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-lg transition-all focus:outline-none touch-friendly min-w-[160px]">
                    <i class="fa fa-refresh mr-2"></i>加载更多
                </button>
            </div>
        </section>
        
        <!-- 提示框 -->
        <div id="error-alert" class="bg-red-50 border-l-4 border-red-400 p-4 mb-6 hidden">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa fa-exclamation-circle text-red-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium text-red-700 mb-1">操作失败</p>
                    <p id="error-message" class="text-sm text-red-700">发生错误，请重试</p>
                    <p class="mt-1 text-xs text-red-500" id="error-tips">建议检查网络连接</p>
                </div>
            </div>
        </div>
        
        <div id="success-alert" class="bg-green-50 border-l-4 border-green-400 p-4 mb-6 hidden">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa fa-check-circle text-green-500"></i>
                </div>
                <div class="ml-3">
                    <p id="success-message" class="text-sm text-green-700">操作成功</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 图片放大模态框 -->
    <div class="modal-backdrop" id="image-modal">
        <div class="modal-content">
            <span class="modal-close" id="modal-close">&times;</span>
            <div class="modal-loading" id="modal-loading">
                <i class="fa fa-circle-o-notch fa-spin mr-2"></i> 加载中...
            </div>
            <img src="" alt="大图预览" class="modal-image hidden" id="modal-image">
        </div>
    </div>
    
    <footer class="bg-gray-100 py-6 mt-10 sm:mt-16">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p>所有留言均公开存储 | <a href="https://github.com" class="text-primary hover:underline">GitHub</a></p>
        </div>
    </footer>

    <script>
        // 登录状态检查
        function checkLoginStatus() {
            const loginInfo = localStorage.getItem('loginInfo');
            if (!loginInfo) return false;
            
            const { expires } = JSON.parse(loginInfo);
            if (new Date().getTime() >= expires) {
                localStorage.removeItem('loginInfo');
                return false;
            }
            return true;
        }
        
        function logout() {
            localStorage.removeItem('loginInfo');
            window.location.href = 'login.html';
        }
        
        // 等待DOM加载完成
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkLoginStatus()) {
                const pageContent = document.querySelector('.container.max-w-4xl');
                const header = document.querySelector('header');
                if (pageContent) pageContent.innerHTML = '';
                if (header) header.style.display = 'none';
                
                const loginTip = document.createElement('div');
                loginTip.style.cssText = `
                    text-align: center; margin-top: 100px; font-size: 18px;
                    padding: 20px; background: white; width: 80%; max-width: 500px;
                    margin-left: auto; margin-right: auto; border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                `;
                loginTip.innerHTML = `
                    <p>请先登录才能访问留言区</p>
                    <button onclick="window.location.href='login.html'" style="margin-top:15px; padding:8px 20px; background:#3b75da; color:white; border:none; border-radius:5px; cursor:pointer;">
                        前往登录
                    </button>
                `;
                document.body.appendChild(loginTip);
                return;
            }
            
            // 显示当前用户
            const { username } = JSON.parse(localStorage.getItem('loginInfo'));
            const userElement = document.getElementById('current-user');
            if (userElement) userElement.textContent = `（当前登录：${username}）`;
            
            // 加密工具
            const CryptoUtils = {
                encrypt: (str, shift = 3) => btoa([...str].map(c => String.fromCharCode(c.charCodeAt(0) + shift)).join('')),
                decrypt: (encryptedStr, shift = 3) => {
                    try {
                        return [...atob(encryptedStr)].map(c => String.fromCharCode(c.charCodeAt(0) - shift)).join('');
                    } catch (e) {
                        console.error('解密失败:', e);
                        return '';
                    }
                }
            };
            
            // GitHub配置
            const config = {
                owner: "fyk-666",  
                repo: "kczx",        
                branch: "main",          
                encryptedToken: "amtzYlB6VEw1RztvVG9PW3l3UzhNUDxXS28zczZ3M0lpdDVJOXtWRQ==",
                cacheExpire: 30 * 60 * 1000, // 缓存30分钟
                pageSize: 10 // 每页10条
            };
            const githubConfig = { ...config, token: CryptoUtils.decrypt(config.encryptedToken) };
            
            // 全局变量
            let allMessages = [];
            let currentPage = 1;
            let totalMessages = 0;
            let isLoading = false;
            let sortOrder = 'newest';
            let selectedImage = null;
            let compressedImage = null; // 压缩后的图片
            
            // DOM元素
            const dom = {
                messagesList: document.getElementById('messages-list'),
                messageCount: document.getElementById('message-count'),
                loadMoreBtn: document.getElementById('load-more'),
                sortNewestBtn: document.getElementById('sort-newest'),
                sortOldestBtn: document.getElementById('sort-oldest'),
                messageInput: document.getElementById('message'),
                charCount: document.getElementById('char-count'),
                submitBtn: document.getElementById('submit-btn'),
                imageUpload: document.getElementById('image-upload'),
                imagePreview: document.getElementById('image-preview'),
                imagePreviewContainer: document.getElementById('image-preview-container'),
                imageSizeError: document.getElementById('image-size-error'),
                imageCompressInfo: document.getElementById('image-compress-info'),
                originalSize: document.getElementById('original-size'),
                compressedSize: document.getElementById('compressed-size'),
                guestbookForm: document.getElementById('guestbook-form'),
                imageDropArea: document.getElementById('image-drop-area'),
                errorAlert: document.getElementById('error-alert'),
                errorMessage: document.getElementById('error-message'),
                errorTips: document.getElementById('error-tips'),
                successAlert: document.getElementById('success-alert'),
                successMessage: document.getElementById('success-message'),
                // 图片模态框
                imageModal: document.getElementById('image-modal'),
                modalClose: document.getElementById('modal-close'),
                modalImage: document.getElementById('modal-image'),
                modalLoading: document.getElementById('modal-loading')
            };
            
            // 字符计数
            if (dom.messageInput && dom.charCount) {
                dom.messageInput.addEventListener('input', () => {
                    const len = dom.messageInput.value.length;
                    dom.charCount.textContent = `${len}/2000 字符`;
                    dom.submitBtn.disabled = len > 2000;
                    dom.charCount.classList.toggle('text-red-500', len > 2000);
                });
            }
            
            // 【核心优化1：图片压缩函数】限制尺寸和质量，最大2MB
            function compressImage(file, maxWidth = 1200, maxHeight = 1200, quality = 0.8) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            // 计算压缩后的尺寸（等比例缩放）
                            let width = img.width;
                            let height = img.height;
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                            
                            // 使用canvas压缩
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // 转换为Blob（二进制）
                            canvas.toBlob((blob) => {
                                // 若仍超过2MB，降低质量重试
                                if (blob.size > 2 * 1024 * 1024) {
                                    compressImage(file, maxWidth, maxHeight, quality - 0.2).then(resolve);
                                } else {
                                    resolve({ blob, originalSize: file.size, compressedSize: blob.size });
                                }
                            }, file.type || 'image/jpeg', quality);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            // 【核心优化2：图片上传+压缩处理】
            async function handleImageSelect(e) {
                const file = e.target.files?.[0];
                if (!file) return;
                
                // 验证文件类型
                if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
                    showError('不支持的文件类型', '仅支持jpg、png、gif');
                    dom.imageUpload.value = '';
                    return;
                }
                
                // 显示压缩中提示
                dom.imagePreviewContainer.classList.remove('hidden');
                dom.imagePreview.src = '';
                dom.imagePreviewContainer.innerHTML = '<div class="image-skeleton w-full h-full"></div>';
                
                try {
                    // 压缩图片
                    const { blob, originalSize, compressedSize } = await compressImage(file);
                    compressedImage = blob;
                    
                    // 显示压缩后预览
                    dom.imagePreviewContainer.innerHTML = `<img id="image-preview" class="image-preview" src="" alt="预览图">`;
                    dom.imagePreview = document.getElementById('image-preview');
                    dom.imagePreview.src = URL.createObjectURL(blob);
                    
                    // 显示压缩信息
                    dom.imageSizeError.classList.add('hidden');
                    dom.imageCompressInfo.classList.remove('hidden');
                    dom.originalSize.textContent = formatFileSize(originalSize);
                    dom.compressedSize.textContent = formatFileSize(compressedSize);
                    
                    // 若原始文件过大，提示已压缩
                    if (originalSize > 2 * 1024 * 1024) {
                        dom.imageSizeError.classList.remove('hidden');
                    }
                } catch (e) {
                    console.error('图片压缩失败:', e);
                    showError('图片处理失败', '请更换图片重试');
                    dom.imagePreviewContainer.classList.add('hidden');
                    dom.imageUpload.value = '';
                }
            }
            
            // 格式化文件大小（B→KB/MB）
            function formatFileSize(bytes) {
                if (bytes < 1024) return `${bytes}B`;
                if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)}KB`;
                return `${(bytes / (1024 * 1024)).toFixed(1)}MB`;
            }
            
            // 拖拽上传
            if (dom.imageDropArea && dom.imageUpload) {
                dom.imageDropArea.addEventListener('dragover', e => {
                    e.preventDefault();
                    dom.imageDropArea.classList.add('border-primary');
                });
                
                dom.imageDropArea.addEventListener('dragleave', () => {
                    dom.imageDropArea.classList.remove('border-primary');
                });
                
                dom.imageDropArea.addEventListener('drop', e => {
                    e.preventDefault();
                    dom.imageDropArea.classList.remove('border-primary');
                    if (e.dataTransfer.files.length) {
                        dom.imageUpload.files = e.dataTransfer.files;
                        handleImageSelect({ target: dom.imageUpload });
                    }
                });
                
                dom.imageDropArea.addEventListener('click', () => dom.imageUpload.click());
                dom.imageUpload.addEventListener('change', handleImageSelect);
            }
            
            // 表单提交（使用压缩后的图片）
            if (dom.guestbookForm) {
                dom.guestbookForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('name').value.trim();
                    const message = dom.messageInput.value.trim();
                    
                    if (!name || !message) {
                        showError('必填项不能为空', '请填写昵称和留言内容');
                        return;
                    }
                    
                    dom.submitBtn.disabled = true;
                    dom.submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>发送中...';
                    
                    try {
                        let imageUrl = null;
                        // 上传压缩后的图片
                        if (compressedImage) {
                            const fileName = `img-${Date.now()}-${Math.random().toString(36).slice(2, 8)}.${compressedImage.type.split('/')[1] || 'jpg'}`;
                            
                            // 转换压缩后的图片为Base64
                            const imageContent = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = e => resolve(e.target.result.split(',')[1]);
                                reader.onerror = reject;
                                reader.readAsDataURL(compressedImage);
                            });
                            
                            // 上传到GitHub
                            const res = await fetchWithTimeout(
                                `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/images/${fileName}`,
                                {
                                    method: 'PUT',
                                    headers: {
                                        'Authorization': `token ${githubConfig.token}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        message: `Add image: ${name}`,
                                        content: imageContent,
                                        branch: githubConfig.branch
                                    })
                                },
                                15000
                            );
                            
                            if (!res.ok) throw new Error(`图片上传失败（${res.status}）`);
                            const data = await res.json();
                            imageUrl = data.content.download_url;
                        }
                        
                        // 保存留言
                        const msgFileName = `${new Date().toISOString().replace(/[:.]/g, '-')}-${Date.now().toString().slice(0, 8)}.json`;
                        const msgContent = btoa(String.fromCharCode(...new TextEncoder().encode(JSON.stringify({
                            id: Date.now().toString(),
                            name,
                            message,
                            imageUrl,
                            thumbnailUrl: imageUrl ? imageUrl + '?size=300' : null, // 缩略图URL（假设支持size参数）
                            timestamp: new Date().toISOString()
                        }, null, 2))));
                        
                        const res = await fetchWithTimeout(
                            `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/messages/${msgFileName}`,
                            {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `token ${githubConfig.token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    message: `Add message: ${name}`,
                                    content: msgContent,
                                    branch: githubConfig.branch
                                })
                            },
                            15000
                        );
                        
                        if (!res.ok) {
                            const err = await res.json().catch(() => ({ message: '未知错误' }));
                            throw new Error(`留言保存失败：${err.message}（${res.status}）`);
                        }
                        
                        // 重置表单
                        document.getElementById('name').value = '';
                        dom.messageInput.value = '';
                        dom.charCount.textContent = '0/2000 字符';
                        dom.imageUpload.value = '';
                        dom.imagePreviewContainer.classList.add('hidden');
                        dom.imageCompressInfo.classList.add('hidden');
                        selectedImage = null;
                        compressedImage = null;
                        
                        showSuccess('留言发送成功！');
                        loadMessages(1, true); // 强制刷新缓存
                    } catch (e) {
                        console.error('提交失败:', e);
                        showError(e.message, '请检查网络或联系管理员');
                    } finally {
                        dom.submitBtn.disabled = false;
                        dom.submitBtn.innerHTML = '<i class="fa fa-paper-plane mr-2"></i>发送留言';
                    }
                });
            }
            
            // 排序按钮
            if (dom.sortNewestBtn && dom.sortOldestBtn) {
                const updateSortButtons = () => {
                    if (sortOrder === 'newest') {
                        dom.sortNewestBtn.classList.add('bg-primary', 'text-white');
                        dom.sortNewestBtn.classList.remove('bg-gray-100', 'text-gray-700');
                        dom.sortOldestBtn.classList.add('bg-gray-100', 'text-gray-700');
                        dom.sortOldestBtn.classList.remove('bg-primary', 'text-white');
                    } else {
                        dom.sortOldestBtn.classList.add('bg-primary', 'text-white');
                        dom.sortOldestBtn.classList.remove('bg-gray-100', 'text-gray-700');
                        dom.sortNewestBtn.classList.add('bg-gray-100', 'text-gray-700');
                        dom.sortNewestBtn.classList.remove('bg-primary', 'text-white');
                    }
                };
                
                dom.sortNewestBtn.addEventListener('click', () => {
                    if (sortOrder !== 'newest') {
                        sortOrder = 'newest';
                        updateSortButtons();
                        sortMessages();
                        currentPage = 1;
                        renderMessages(allMessages.slice(0, config.pageSize));
                    }
                });
                
                dom.sortOldestBtn.addEventListener('click', () => {
                    if (sortOrder !== 'oldest') {
                        sortOrder = 'oldest';
                        updateSortButtons();
                        sortMessages();
                        currentPage = 1;
                        renderMessages(allMessages.slice(0, config.pageSize));
                    }
                });
            }
            
            // 【优化1：本地缓存工具】
            const Cache = {
                get(key) {
                    const item = localStorage.getItem(key);
                    if (!item) return null;
                    const { data, time } = JSON.parse(item);
                    // 检查缓存是否过期
                    if (new Date().getTime() - time > config.cacheExpire) {
                        localStorage.removeItem(key);
                        return null;
                    }
                    return data;
                },
                set(key, data) {
                    localStorage.setItem(key, JSON.stringify({
                        data,
                        time: new Date().getTime()
                    }));
                }
            };

            // 【优化2：带缓存的留言加载函数】
            async function loadMessages(page = 1, forceRefresh = false) {
                if (isLoading) return;
                isLoading = true;
                dom.loadMoreBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>加载中...';

                try {
                    // 先查缓存
                    const cacheKey = `messages_page_${page}`;
                    if (!forceRefresh) {
                        const cached = Cache.get(cacheKey);
                        if (cached) {
                            allMessages = allMessages.concat(cached); // 合并缓存数据
                            renderMessages(cached);
                            isLoading = false;
                            updateLoadMore();
                            return;
                        }
                    }

                    // 缓存未命中，请求GitHub API
                    const filesRes = await fetchWithTimeout(
                        `https://api.github.com/repos/${config.owner}/${config.repo}/contents/messages?ref=${config.branch}`,
                        { headers: { 'Accept': 'application/vnd.github.v3+json' } },
                        8000 // 8秒超时
                    );

                    if (!filesRes.ok) throw new Error(`API请求失败: ${filesRes.status}`);
                    const allFiles = await filesRes.json();
                    const jsonFiles = allFiles.filter(f => f.name.endsWith('.json')).reverse(); // 倒序（最新在前）
                    totalMessages = jsonFiles.length;

                    // 分页截取（只取当前页数据）
                    const start = (page - 1) * config.pageSize;
                    const end = start + config.pageSize;
                    const currentFiles = jsonFiles.slice(start, end);

                    // 批量请求当前页的留言内容（减少并发数）
                    const messages = [];
                    for (const file of currentFiles) { // 改用for循环限制并发，避免请求过于密集
                        try {
                            const msgRes = await fetchWithTimeout(file.download_url, {}, 5000);
                            if (msgRes.ok) {
                                const msg = await msgRes.json();
                                messages.push(msg);
                            }
                        } catch (e) {
                            console.warn(`跳过无效留言: ${file.name}`, e);
                        }
                    }

                    // 缓存当前页数据
                    Cache.set(cacheKey, messages);
                    allMessages = allMessages.concat(messages); // 合并到全局数据
                    renderMessages(messages);
                } catch (e) {
                    console.error('加载失败:', e);
                    dom.messagesList.innerHTML = `
                        <div class="text-center py-10 bg-red-50 rounded-lg">
                            <i class="fa fa-exclamation-triangle text-4xl text-red-300 mb-3"></i>
                            <p class="text-red-700 mb-2">${e.message}</p>
                            <button onclick="loadMessages(1, true)" class="mt-3 px-4 py-2 bg-primary text-white rounded hover:bg-primary/90">
                                重试加载
                            </button>
                        </div>
                    `;
                } finally {
                    isLoading = false;
                    updateLoadMore();
                }
            }

            // 【优化3：排序留言】
            function sortMessages() {
                allMessages.sort((a, b) => {
                    const timeA = new Date(a.timestamp).getTime();
                    const timeB = new Date(b.timestamp).getTime();
                    return sortOrder === 'newest' ? timeB - timeA : timeA - timeB;
                });
            }

            // 【优化4：批量渲染留言（减少DOM操作）】
            function renderMessages(messages) {
                if (!dom.messagesList || !dom.loadMoreBtn) return;

                if (allMessages.length === 0) {
                    dom.messagesList.innerHTML = `
                        <div class="text-center py-10 bg-gray-50 rounded-lg">
                            <i class="fa fa-comment-o text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">还没有留言，快来写下第一条吧！</p>
                        </div>
                    `;
                    dom.loadMoreBtn.disabled = true;
                    dom.loadMoreBtn.innerHTML = '<i class="fa fa-check mr-2"></i>没有更多留言';
                    return;
                }

                const fragment = document.createDocumentFragment(); // 文档片段，批量插入

                messages.forEach(msg => {
                    const el = document.createElement('div');
                    el.className = 'bg-white rounded-xl shadow-md p-4 sm:p-6 hover:shadow-lg transition-shadow message-appear';
                    
                    let content = `<div class="text-gray-700 whitespace-pre-line">${escapeHtml(msg.message)}</div>`;
                    if (msg.imageUrl) {
                        // 使用缩略图懒加载（优先加载小图）
                        const thumbnailUrl = msg.thumbnailUrl || msg.imageUrl; // 优先用缩略图
                        content += `
                            <div class="mt-3 rounded-lg overflow-hidden border border-gray-100">
                                <div class="image-skeleton w-full" style="padding-top: 56.25%;"> <!-- 16:9比例占位 -->
                                    <img 
                                        data-src="${thumbnailUrl}" 
                                        class="lazy-load image-preview absolute top-0 left-0 w-full h-full" 
                                        alt="留言图片"
                                        onclick="openImageModal('${msg.imageUrl}')"
                                    >
                                </div>
                            </div>
                        `;
                    }
                    
                    el.innerHTML = `
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 font-bold mr-3">
                                    ${msg.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">${escapeHtml(msg.name)}</h3>
                                </div>
                            </div>
                            <span class="text-sm text-gray-400">${formatDate(msg.timestamp)}</span>
                        </div>
                        ${content}
                    `;
                    fragment.appendChild(el);
                });

                dom.messagesList.appendChild(fragment); // 一次插入所有节点，减少重排
                initLazyLoad(); // 初始化当前页的图片懒加载
            }

            // 【优化5：图片懒加载初始化】
            function initLazyLoad() {
                const lazyImages = document.querySelectorAll('img.lazy-load:not(.loaded)');
                if ('IntersectionObserver' in window) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                img.src = img.dataset.src; // 加载真实图片
                                img.classList.remove('lazy-load');
                                img.classList.add('loaded');
                                observer.unobserve(img); // 停止观察
                                
                                // 图片加载失败时显示占位图
                                img.onerror = () => {
                                    img.src = 'https://via.placeholder.com/300?text=图片加载失败';
                                };
                            }
                        });
                    }, { rootMargin: '200px' }); // 提前200px开始加载

                    lazyImages.forEach(img => observer.observe(img));
                } else {
                    // 降级处理（兼容旧浏览器）
                    lazyImages.forEach(img => {
                        img.src = img.dataset.src;
                        img.classList.remove('lazy-load');
                        img.classList.add('loaded');
                    });
                }
            }

            // 【核心优化4：图片放大模态框】
            function initImageModal() {
                // 关闭模态框
                dom.modalClose.addEventListener('click', () => {
                    dom.imageModal.classList.remove('active');
                    dom.modalImage.classList.add('hidden');
                    dom.modalLoading.classList.remove('hidden');
                });
                
                // 点击模态框背景关闭
                dom.imageModal.addEventListener('click', (e) => {
                    if (e.target === dom.imageModal) {
                        dom.imageModal.classList.remove('active');
                        dom.modalImage.classList.add('hidden');
                        dom.modalLoading.classList.remove('hidden');
                    }
                });
            }
            
            // 打开图片模态框
            function openImageModal(url) {
                dom.imageModal.classList.add('active');
                dom.modalImage.classList.add('hidden');
                dom.modalLoading.classList.remove('hidden');
                dom.modalImage.src = ''; // 重置图片
                
                // 加载高清图
                const img = new Image();
                img.onload = () => {
                    dom.modalImage.src = url;
                    dom.modalImage.classList.remove('hidden');
                    dom.modalLoading.classList.add('hidden');
                };
                img.onerror = () => {
                    dom.modalImage.src = 'https://via.placeholder.com/500?text=图片加载失败';
                    dom.modalImage.classList.remove('hidden');
                    dom.modalLoading.classList.add('hidden');
                };
                img.src = url;
            }

            // 更新加载更多按钮状态
            function updateLoadMore() {
                if (!dom.loadMoreBtn) return;
                if (currentPage * config.pageSize >= totalMessages) {
                    dom.loadMoreBtn.innerHTML = '没有更多留言';
                    dom.loadMoreBtn.disabled = true;
                    dom.loadMoreBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    dom.loadMoreBtn.innerHTML = '<i class="fa fa-refresh mr-2"></i>加载更多';
                    dom.loadMoreBtn.disabled = false;
                    dom.loadMoreBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            // 绑定加载更多事件
            if (dom.loadMoreBtn) {
                dom.loadMoreBtn.addEventListener('click', () => {
                    currentPage++;
                    loadMessages(currentPage);
                });
            }

            // 工具函数：超时请求
            function fetchWithTimeout(url, options, timeout = 10000) {
                return Promise.race([
                    fetch(url, options),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('请求超时')), timeout)
                    )
                ]);
            }

            // 工具函数：格式化日期
            function formatDate(dateStr) {
                return new Intl.DateTimeFormat('zh-CN', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                }).format(new Date(dateStr));
            }

            // 工具函数：防XSS
            function escapeHtml(str) {
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            }

            function showError(msg, tips) {
                if (dom.errorMessage && dom.errorTips && dom.errorAlert) {
                    dom.errorMessage.textContent = msg;
                    dom.errorTips.textContent = tips ? `提示：${tips}` : '请检查网络';
                    dom.errorAlert.classList.remove('hidden');
                    setTimeout(() => dom.errorAlert.classList.add('hidden'), 8000);
                }
            }

            function showSuccess(msg) {
                if (dom.successMessage && dom.successAlert) {
                    dom.successMessage.textContent = msg;
                    dom.successAlert.classList.remove('hidden');
                    setTimeout(() => dom.successAlert.classList.add('hidden'), 3000);
                }
            }

            // 暴露全局函数
            window.loadMessages = loadMessages;
            window.openImageModal = openImageModal;
            
            // 初始化
            initImageModal();
            loadMessages(1); // 初始加载第一页
        });
    </script>
</body>
</html>
